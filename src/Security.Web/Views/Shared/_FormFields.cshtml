@* Reusable dynamic extension fields renderer *@
@using Security.Domain.Entities
@model List<FormFieldDefinition>

@{
    var extValues = ViewData["ExtValues"] as Dictionary<string, string?> ?? new Dictionary<string, string?>();
}

@foreach (var field in Model.OrderBy(f => f.Order))
{
    var fieldId = $"ext_{field.Key}";
    var value = extValues.TryGetValue(field.Key, out var v) ? v : null;
    var isInvalid = ViewData.ModelState.ContainsKey(fieldId) && ViewData.ModelState[fieldId]!.Errors.Count > 0;
    var errorClass = isInvalid ? "is-invalid" : "";
    <div class="mb-3">
        <label for="@fieldId" class="form-label">
            @field.Label
            @if (field.Required) { <span class="text-danger">*</span> }
        </label>
        @switch (field.FieldType)
        {
            case FormFieldType.Text:
                <input type="text" id="@fieldId" name="@fieldId" class="form-control @errorClass"
                       value="@value" placeholder="@field.Placeholder"
                       @(field.Required ? "required" : "") />
                break;
            case FormFieldType.Number:
                <input type="number" id="@fieldId" name="@fieldId" class="form-control @errorClass"
                       value="@value" placeholder="@field.Placeholder"
                       @(field.Required ? "required" : "") />
                break;
            case FormFieldType.Date:
                <input type="date" id="@fieldId" name="@fieldId" class="form-control @errorClass"
                       value="@value" @(field.Required ? "required" : "") />
                break;
            case FormFieldType.Checkbox:
                <div class="form-check">
                    <input type="checkbox" id="@fieldId" name="@fieldId" class="form-check-input @errorClass"
                           value="true" @(value == "true" ? "checked" : "") />
                    <label class="form-check-label" for="@fieldId">@field.Label</label>
                </div>
                break;
            case FormFieldType.Textarea:
                <textarea id="@fieldId" name="@fieldId" class="form-control @errorClass" rows="3"
                          placeholder="@field.Placeholder" @(field.Required ? "required" : "")>@value</textarea>
                break;
            case FormFieldType.Dropdown:
                <select id="@fieldId" name="@fieldId" class="form-select @errorClass"
                        @(field.Required ? "required" : "")>
                    <option value="">-- Select --</option>
                    @foreach (var opt in field.Options)
                    {
                        if (value == opt.Value)
                        {
                            <option value="@opt.Value" selected>@opt.Text</option>
                        }
                        else
                        {
                            <option value="@opt.Value">@opt.Text</option>
                        }
                    }
                </select>
                break;
        }
        @if (!string.IsNullOrEmpty(field.HelpText))
        {
            <div class="form-text">@field.HelpText</div>
        }
        @if (isInvalid)
        {
            <div class="invalid-feedback">@ViewData.ModelState[fieldId]!.Errors[0].ErrorMessage</div>
        }
    </div>
}
